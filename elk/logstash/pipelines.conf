# Beats -> Logstash -> Elasticsearch
# Listens on :5044 for Filebeat/Metricbeat
input {
  beats {
    port => 5044
    # ssl => true
    # ssl_certificate => "/etc/logstash/certs/logstash.crt"
    # ssl_key => "/etc/logstash/certs/logstash.key"
  }
}

filter {
  # Try to parse JSON logs if the message is JSON
  json {
    source => "message"
    skip_on_invalid_json => true
  }

  # Add common fields if missing
  if ![host] { mutate { add_field => { "host" => "%{[host][name]}" } } }
  if ![env]  { mutate { add_field => { "env"  => "prod" } } }

  # Example: parse nginx combined logs (uncomment if needed)
  # if [fileset][module] == "nginx" and [fileset][name] == "access" {
  #   grok {
  #     match => { "message" => "%{NGINXACCESS}" }
  #   }
  # }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "%{[@metadata][beat]}-%{+YYYY.MM.dd}"
    manage_template => false
  }

  # For debugging
  # stdout { codec => rubydebug }
}
